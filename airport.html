<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>ATC Radar Map Editor</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  background: #010147;
  overflow: hidden;
  font-family: Arial, sans-serif;
}

#toolbar {
  position: absolute;
  top: 10px;
  left: 10px;
  z-index: 10;
}

button {
  margin: 2px;
  padding: 6px 10px;
  cursor: pointer;
}

#zoomContainer {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  z-index: 10;
}

#zoomSlider {
  writing-mode: bt-lr;
  -webkit-appearance: slider-vertical;
  width: 8px;
  height: 200px;
}

canvas {
  display: block;
}
</style>
</head>
<body>

<div id="toolbar">
  <button id="btnAddAirport">Ajouter aéroport</button>
  <button id="btnAddFinal">Ajouter finale</button>
  <button id="btnAddRunway">Ajouter piste</button>
  <button id="btnLock">Lock / Unlock</button>
  <button id="btnDelete">Delete</button>
  <button id="btnSave">Save</button>
</div>

<div id="zoomContainer">
  <input id="zoomSlider" type="range" min="0.5" max="2.5" step="0.05" value="1">
</div>

<canvas id="canvas"></canvas>

<script>
// ================= FIREBASE =================
firebase.initializeApp({
  apiKey: "AIzaSyDxDzLbCnqYYVknoyHMzbE0gB_SRVLpgiw",
  authDomain: "kyky-c3471.firebaseapp.com",
  databaseURL: "https://kyky-c3471-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "kyky-c3471",
  storageBucket: "kyky-c3471.firebasestorage.app",
  messagingSenderId: "658643330578",
  appId: "1:658643330578:web:758dc26d5504a503e39acb",
  measurementId: "G-245RE41YQK"
});
const db = firebase.database();

// ================= CANVAS =================
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

ctx.imageSmoothingEnabled = true;
ctx.imageSmoothingQuality = "high";

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
resize();
window.addEventListener("resize", resize);

// ================= ZOOM =================
let zoom = 1;
const zoomSlider = document.getElementById("zoomSlider");
zoomSlider.addEventListener("input", () => {
  zoom = parseFloat(zoomSlider.value);
});

// ================= DATA =================
let objects = [];
let selectedObject = null;
let selectedEndpoint = null;

// ================= CLASSES =================
class Airport {
  constructor(data) {
    Object.assign(this, data);
    this.type = "airport";
    this.img = new Image();
    this.img.src = "./airport.png";
  }

  draw() {
    ctx.drawImage(
      this.img,
      this.x - 25 * this.scale,
      this.y - 25 * this.scale,
      50 * this.scale,
      50 * this.scale
    );

    if (this === selectedObject) {
      ctx.strokeStyle = "yellow";
      ctx.lineWidth = 2;
      ctx.strokeRect(
        this.x - 25 * this.scale,
        this.y - 25 * this.scale,
        50 * this.scale,
        50 * this.scale
      );
    }
  }

  hit(x, y) {
    return (
      x > this.x - 25 * this.scale &&
      x < this.x + 25 * this.scale &&
      y > this.y - 25 * this.scale &&
      y < this.y + 25 * this.scale
    );
  }
}

class Line {
  constructor(data) {
    Object.assign(this, data);
    this.type = "line";
  }

  draw() {
    ctx.strokeStyle = this.color;
    ctx.setLineDash(this.dashed ? [8,6] : []);
    ctx.lineWidth = 2;

    ctx.beginPath();
    ctx.moveTo(this.p1.x, this.p1.y);
    ctx.lineTo(this.p2.x, this.p2.y);
    ctx.stroke();

    ctx.setLineDash([]);
    drawEndpoint(this.p1);
    drawEndpoint(this.p2);
  }
}

function drawEndpoint(p) {
  ctx.fillStyle = (p === selectedEndpoint) ? "yellow" : "white";
  ctx.beginPath();
  ctx.arc(p.x, p.y, 6, 0, Math.PI * 2);
  ctx.fill();
  if (p.label) ctx.fillText(p.label, p.x + 8, p.y - 8);
}

// ================= RENDER =================
function render() {
  ctx.setTransform(zoom, 0, 0, zoom, 0, 0);
  ctx.clearRect(0, 0, canvas.width / zoom, canvas.height / zoom);
  objects.forEach(o => o.draw());
  requestAnimationFrame(render);
}
render();

// ================= MOUSE =================
canvas.addEventListener("click", e => {
  const x = e.clientX / zoom;
  const y = e.clientY / zoom;

  if (selectedEndpoint) {
    selectedEndpoint.x = x;
    selectedEndpoint.y = y;
    selectedEndpoint = null;
    return;
  }

  selectedObject = null;

  for (let o of objects) {
    if (o.type === "airport" && !o.locked && o.hit(x, y)) {
      selectedObject = o;
      return;
    }

    if (o.type === "line") {
      if (dist(x,y,o.p1.x,o.p1.y) < 10) {
        selectedEndpoint = o.p1;
        return;
      }
      if (dist(x,y,o.p2.x,o.p2.y) < 10) {
        selectedEndpoint = o.p2;
        return;
      }
    }
  }
});

// ================= BUTTONS (FIX CRITIQUE) =================
const btnAddAirport = document.getElementById("btnAddAirport");
const btnAddFinal   = document.getElementById("btnAddFinal");
const btnAddRunway  = document.getElementById("btnAddRunway");
const btnLock       = document.getElementById("btnLock");
const btnDelete     = document.getElementById("btnDelete");
const btnSave       = document.getElementById("btnSave");

btnAddAirport.addEventListener("click", () => {
  objects.push(new Airport({
    x: canvas.width / (2 * zoom),
    y: canvas.height / (2 * zoom),
    scale: 1,
    locked: false
  }));
});

btnAddFinal.addEventListener("click", () => {
  const name = prompt("Nom piste finale ?");
  if (!name) return;
  objects.push(new Line({
    color: "orange",
    dashed: true,
    p1: { x: 300, y: 300 },
    p2: { x: 500, y: 500, label: name }
  }));
});

btnAddRunway.addEventListener("click", () => {
  objects.push(new Line({
    color: "green",
    dashed: false,
    p1: { x: 300, y: 300 },
    p2: { x: 500, y: 500 }
  }));
});

btnLock.addEventListener("click", () => {
  if (selectedObject?.type === "airport")
    selectedObject.locked = !selectedObject.locked;
});

btnDelete.addEventListener("click", () => {
  if (selectedObject) {
    objects = objects.filter(o => o !== selectedObject);
    selectedObject = null;
  }
});

btnSave.addEventListener("click", () => {
  db.ref("maps/default").set(JSON.parse(JSON.stringify(objects)));
  alert("Carte sauvegardée !");
});

// ================= LOAD FROM FIREBASE =================
db.ref("maps/default").once("value", snap => {
  const data = snap.val();
  if (!data) return;

  objects = data.map(o => {
    if (o.type === "airport") return new Airport(o);
    if (o.type === "line") return new Line(o);
  });
});

// ================= UTILS =================
function dist(x1,y1,x2,y2) {
  return Math.hypot(x2-x1, y2-y1);
}
</script>

</body>
</html>
