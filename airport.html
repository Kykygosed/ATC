<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>ATC Radar Map Editor</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  background: #010147;
  overflow: hidden;
  font-family: Arial, sans-serif;
}

#toolbar {
  position: absolute;
  top: 10px;
  left: 10px;
  z-index: 10;
}

button {
  margin: 2px;
  padding: 6px 10px;
  cursor: pointer;
}

canvas {
  display: block;
}
</style>
</head>
<body>

<div id="toolbar">
  <button id="addAirport">Ajouter aéroport</button>
  <button id="addFinal">Ajouter finale</button>
  <button id="addRunway">Ajouter piste</button>
  <button id="zoomIn">+</button>
  <button id="zoomOut">-</button>
  <button id="lock">Lock / Unlock</button>
  <button id="delete">Delete</button>
  <button id="save">Save</button>
</div>

<canvas id="canvas"></canvas>

<script>
// ================= FIREBASE =================
firebase.initializeApp({
  apiKey: "AIzaSyDxDzLbCnqYYVknoyHMzbE0gB_SRVLpgiw",
  authDomain: "kyky-c3471.firebaseapp.com",
  databaseURL: "https://kyky-c3471-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "kyky-c3471",
  storageBucket: "kyky-c3471.firebasestorage.app",
  messagingSenderId: "658643330578",
  appId: "1:658643330578:web:758dc26d5504a503e39acb",
  measurementId: "G-245RE41YQK"
});
const db = firebase.database();

// ================= CANVAS =================
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
canvas.width = innerWidth;
canvas.height = innerHeight;

// ================= DATA =================
let objects = [];
let selectedObject = null;
let selectedEndpoint = null;

// ================= CLASSES =================
class Airport {
  constructor(x, y) {
    this.type = "airport";
    this.x = x;
    this.y = y;
    this.scale = 1;
    this.locked = false;
    this.img = new Image();
    this.img.src = "./airport.png";
  }

  draw() {
    ctx.drawImage(
      this.img,
      this.x - 25 * this.scale,
      this.y - 25 * this.scale,
      50 * this.scale,
      50 * this.scale
    );

    if (this === selectedObject) {
      ctx.strokeStyle = "yellow";
      ctx.strokeRect(
        this.x - 25 * this.scale,
        this.y - 25 * this.scale,
        50 * this.scale,
        50 * this.scale
      );
    }
  }

  hit(x, y) {
    return (
      x > this.x - 25 * this.scale &&
      x < this.x + 25 * this.scale &&
      y > this.y - 25 * this.scale &&
      y < this.y + 25 * this.scale
    );
  }
}

class Line {
  constructor(color, dashed, askName = false) {
    this.type = "line";
    this.color = color;
    this.dashed = dashed;
    this.p1 = { x: 300, y: 300, label: null };
    this.p2 = { x: 500, y: 500, label: null };

    if (askName) {
      const name = prompt("Nom de la piste (finale) ?");
      if (name) this.p2.label = name;
    }
  }

  draw() {
    ctx.strokeStyle = this.color;
    ctx.setLineDash(this.dashed ? [8, 6] : []);
    ctx.lineWidth = 2;

    ctx.beginPath();
    ctx.moveTo(this.p1.x, this.p1.y);
    ctx.lineTo(this.p2.x, this.p2.y);
    ctx.stroke();

    ctx.setLineDash([]);

    drawEndpoint(this.p1);
    drawEndpoint(this.p2);
  }
}

function drawEndpoint(p) {
  ctx.fillStyle = (p === selectedEndpoint) ? "yellow" : "white";
  ctx.beginPath();
  ctx.arc(p.x, p.y, 6, 0, Math.PI * 2);
  ctx.fill();

  if (p.label) ctx.fillText(p.label, p.x + 8, p.y - 8);
}

// ================= RENDER =================
function render() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  objects.forEach(o => o.draw());
  requestAnimationFrame(render);
}
render();

// ================= MOUSE =================
canvas.addEventListener("click", e => {
  const x = e.clientX;
  const y = e.clientY;

  // Placement d'une extrémité sélectionnée
  if (selectedEndpoint) {
    selectedEndpoint.x = x;
    selectedEndpoint.y = y;
    selectedEndpoint = null;
    return;
  }

  selectedObject = null;

  for (let o of objects) {
    if (o.type === "airport" && !o.locked && o.hit(x, y)) {
      selectedObject = o;
      return;
    }

    if (o.type === "line") {
      if (distance(x, y, o.p1.x, o.p1.y) < 10) {
        selectedEndpoint = o.p1;
        return;
      }
      if (distance(x, y, o.p2.x, o.p2.y) < 10) {
        selectedEndpoint = o.p2;
        return;
      }
    }
  }
});

canvas.addEventListener("dblclick", e => {
  for (let o of objects) {
    if (o.type === "line") {
      if (distance(e.clientX, e.clientY, o.p1.x, o.p1.y) < 10 && !o.p1.label)
        o.p1.label = prompt("Nom axe piste");
      if (distance(e.clientX, e.clientY, o.p2.x, o.p2.y) < 10 && !o.p2.label)
        o.p2.label = prompt("Nom axe piste");
    }
  }
});

// ================= BUTTONS =================
const btnAddAirport = document.getElementById("addAirport");
const btnAddFinal   = document.getElementById("addFinal");
const btnAddRunway  = document.getElementById("addRunway");
const btnZoomIn     = document.getElementById("zoomIn");
const btnZoomOut    = document.getElementById("zoomOut");
const btnLock       = document.getElementById("lock");
const btnDelete     = document.getElementById("delete");
const btnSave       = document.getElementById("save");

btnAddAirport.onclick = () => {
  objects.push(new Airport(canvas.width / 2, canvas.height / 2));
};

btnAddFinal.onclick = () => {
  objects.push(new Line("orange", true, true));
};

btnAddRunway.onclick = () => {
  objects.push(new Line("green", false));
};

btnZoomIn.onclick = () => {
  if (selectedObject?.type === "airport") selectedObject.scale += 0.1;
};

btnZoomOut.onclick = () => {
  if (selectedObject?.type === "airport" && selectedObject.scale > 0.3)
    selectedObject.scale -= 0.1;
};

btnLock.onclick = () => {
  if (selectedObject?.type === "airport")
    selectedObject.locked = !selectedObject.locked;
};

btnDelete.onclick = () => {
  if (selectedObject) {
    objects = objects.filter(o => o !== selectedObject);
    selectedObject = null;
  }
};

btnSave.onclick = () => {
  db.ref("maps/default").set(JSON.parse(JSON.stringify(objects)));
  alert("Carte sauvegardée !");
};

// ================= UTILS =================
function distance(x1, y1, x2, y2) {
  return Math.hypot(x2 - x1, y2 - y1);
}
</script>

</body>
</html>
