<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>ATC Radar Map Editor</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  background: #010147;
  overflow: hidden;
  font-family: Arial, sans-serif;
}

#toolbar {
  position: absolute;
  top: 10px;
  left: 10px;
  z-index: 10;
}

button {
  margin: 2px;
  padding: 6px 10px;
  cursor: pointer;
}

canvas {
  display: block;
}
</style>
</head>
<body>

<div id="toolbar">
  <button id="addAirport">Ajouter aéroport</button>
  <button id="addFinal">Ajouter finale</button>
  <button id="addRunway">Ajouter piste</button>
  <button id="zoomIn">+</button>
  <button id="zoomOut">-</button>
  <button id="lock">Lock / Unlock</button>
  <button id="delete">Delete</button>
  <button id="save">Save</button>
</div>

<canvas id="canvas"></canvas>

<script>
// ================= FIREBASE =================
firebase.initializeApp({
  apiKey: "AIzaSyDxDzLbCnqYYVknoyHMzbE0gB_SRVLpgiw",
  authDomain: "kyky-c3471.firebaseapp.com",
  databaseURL: "https://kyky-c3471-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "kyky-c3471",
  storageBucket: "kyky-c3471.firebasestorage.app",
  messagingSenderId: "658643330578",
  appId: "1:658643330578:web:758dc26d5504a503e39acb",
  measurementId: "G-245RE41YQK"
});
const db = firebase.database();

// ================= CANVAS =================
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
canvas.width = innerWidth;
canvas.height = innerHeight;

// ================= DATA =================
let objects = [];
let selected = null;
let dragPoint = null;

// ================= CLASSES =================
class Airport {
  constructor(x, y) {
    this.type = "airport";
    this.x = x;
    this.y = y;
    this.scale = 1;
    this.locked = false;
    this.img = new Image();
    this.img.src = "airport.png";
  }

  draw() {
    ctx.drawImage(this.img,
      this.x - 25 * this.scale,
      this.y - 25 * this.scale,
      50 * this.scale,
      50 * this.scale
    );
    if (this === selected) {
      ctx.strokeStyle = "yellow";
      ctx.strokeRect(this.x - 25, this.y - 25, 50, 50);
    }
  }

  hit(x, y) {
    return x > this.x - 25 && x < this.x + 25 &&
           y > this.y - 25 && y < this.y + 25;
  }
}

class Line {
  constructor(color, dashed, askName = false) {
    this.type = "line";
    this.color = color;
    this.dashed = dashed;
    this.p1 = { x: 200, y: 200, label: null };
    this.p2 = { x: 400, y: 400, label: null };

    if (askName) {
      const name = prompt("Nom de la piste ?");
      if (name) this.p2.label = name;
    }
  }

  draw() {
    ctx.strokeStyle = this.color;
    ctx.setLineDash(this.dashed ? [8,6] : []);
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(this.p1.x, this.p1.y);
    ctx.lineTo(this.p2.x, this.p2.y);
    ctx.stroke();
    ctx.setLineDash([]);

    drawPoint(this.p1);
    drawPoint(this.p2);
  }
}

function drawPoint(p) {
  ctx.fillStyle = "white";
  ctx.beginPath();
  ctx.arc(p.x, p.y, 5, 0, Math.PI*2);
  ctx.fill();
  if (p.label) ctx.fillText(p.label, p.x + 8, p.y - 8);
}

// ================= LOOP =================
function render() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  objects.forEach(o => o.draw());
  requestAnimationFrame(render);
}
render();

// ================= MOUSE =================
canvas.onmousedown = e => {
  const x = e.clientX;
  const y = e.clientY;

  for (let o of objects) {
    if (o.type === "airport" && o.hit(x,y) && !o.locked) {
      selected = o;
      return;
    }
    if (o.type === "line") {
      if (dist(x,y,o.p1.x,o.p1.y) < 10) dragPoint = o.p1;
      if (dist(x,y,o.p2.x,o.p2.y) < 10) dragPoint = o.p2;
    }
  }
};

canvas.onmousemove = e => {
  if (selected) {
    selected.x = e.clientX;
    selected.y = e.clientY;
  }
  if (dragPoint) {
    dragPoint.x = e.clientX;
    dragPoint.y = e.clientY;
  }
};

canvas.onmouseup = () => {
  selected = null;
  dragPoint = null;
};

canvas.ondblclick = e => {
  for (let o of objects) {
    if (o.type === "line") {
      if (dist(e.clientX,e.clientY,o.p1.x,o.p1.y) < 10 && !o.p1.label)
        o.p1.label = prompt("Nom axe piste");
      if (dist(e.clientX,e.clientY,o.p2.x,o.p2.y) < 10 && !o.p2.label)
        o.p2.label = prompt("Nom axe piste");
    }
  }
};

// ================= BUTTONS =================
addAirport.onclick = () => objects.push(new Airport(300,300));
addFinal.onclick = () => objects.push(new Line("orange", true, true));
addRunway.onclick = () => objects.push(new Line("green", false));
zoomIn.onclick = () => selected && selected.scale && (selected.scale += 0.1);
zoomOut.onclick = () => selected && selected.scale && (selected.scale -= 0.1);
lock.onclick = () => selected && (selected.locked = !selected.locked);
delete.onclick = () => selected && (objects = objects.filter(o => o !== selected));
save.onclick = () => {
  db.ref("maps/default").set(JSON.parse(JSON.stringify(objects)));
  alert("Carte sauvegardée !");
};

// ================= UTILS =================
function dist(x1,y1,x2,y2){
  return Math.hypot(x2-x1,y2-y1);
}
</script>

</body>
</html>
