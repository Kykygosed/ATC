<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Morse Radio – Spectrogramme</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<style>
/* ================= GLOBAL ================= */
body{
  margin:0;
  background: radial-gradient(circle at top, #1c1c1c, #0b0b0b);
  color:#fff;
  font-family: system-ui, Arial, sans-serif;
  touch-action: manipulation;
}

#popup{
  position:fixed;
  inset:0;
  background:#000c;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:10;
}

#popup input,#popup button{
  font-size:18px;
  padding:12px;
  border-radius:8px;
  border:none;
}

/* ================= APP ================= */
.app{
  max-width:1300px;
  margin:auto;
  padding:25px;
}
#freqSlider {
  width: 100%;       /* occupe toute la largeur disponible */
  max-width: 600px;  /* largeur max si tu veux limiter */
  height: 16px;      /* un peu plus large pour mieux cliquer */
  margin: 10px 0;
}

/* ================= FREQUENCE ================= */
.freq-box{
  border:4px solid #c9c7ff;
  border-radius:14px;
  padding:25px;
  font-size:86px;
  text-align:center;
  margin-bottom:20px;
}

/* ================= AUTO MODE ================= */
.auto{
  display:flex;
  align-items:center;
  gap:12px;
  font-size:22px;
  margin-bottom:25px;
}

/* ================= USER BOX ================= */
.user-box{
  background:rgba(255,255,255,0.03);
  border:2px solid rgba(255,255,255,0.15);
  border-radius:14px;
  padding:16px;
  margin-bottom:20px;
}

.user-header{
  display:flex;
  justify-content:space-between;
  font-size:22px;
  margin-bottom:10px;
}

.user-translation{
  opacity:.6;
  font-style:italic;
}

canvas{
  width:100%;
  height:140px;
  background:#0f0f0f;
  border-radius:8px;
  display:block;
}
button{
  touch-action: manipulation;
}

/* ================= CONTROLS ================= */
.controls{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:30px;
  margin-top:30px;
}

.morse-btn{
  width:90px;
  height:90px;
  border-radius:50%;
  font-size:42px;
  border:none;
  cursor:pointer;
  background:linear-gradient(145deg,#1f1f1f,#111);
  color:white;
  box-shadow: inset 0 0 0 2px #333;
}

.morse-btn:active{
  background:#0af;
  color:#000;
}


.dot{color:#6cf;}
.dash{color:#0af;}

.clear-btn{
  padding:14px 26px;
  font-size:18px;
  border-radius:10px;
  border:2px solid #444;
  background:#222;
  color:#fff;
  cursor:pointer;
}
</style>
</head>

<body>

<div id="popup">
  <div>
    <input id="pseudoInput" placeholder="Pseudo"><br><br>
    <label for="freqSlider">Fréquence : <span id="freqLabel">122.000</span> MHz</label><br>

<div style="display:flex; align-items:center; gap:10px;">
  <button id="freqMinus">- 1 MHz</button>
  <input type="range" id="freqSlider" min="118" max="137" step="0.001" value="122">
  <button id="freqPlus">+ 1 MHz</button>
</div>

    <button onclick="enterRadio()">Entrer</button>
  </div>
</div>

<div class="app">

  <!-- FREQUENCE -->
  <div class="freq-box" id="freqDisplay">Fréquence active</div>

  <!-- AUTO MODE -->
  <label class="auto">
    <input type="checkbox" id="translateMode" checked>
    Mode auto-Traduction
  </label>

  <!-- VOUS -->
  <div class="user-box">
    <div class="user-header">
      <span>Vous</span>
      <span class="user-translation" id="receptionText-vous">(Traduction ici)</span>
    </div>
    <canvas id="tx" width="1200" height="140"></canvas>
  </div>

  <!-- AUTRES UTILISATEURS -->
  <div id="receptionText"></div>
  
<div class="controls">
  <button class="morse-btn dot" onclick="emit('.')">•</button>
  <button class="morse-btn dash" onclick="emit('-')">—</button>
  <button class="clear-btn" onclick="clearTranslation()">Clear</button>
</div>


</div>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
// ================= FIREBASE =================
const firebaseConfig = {
  apiKey: "AIzaSyDxDzLbCnqYYVknoyHMzbE0gB_SRVLpgiw",
  authDomain: "kyky-c3471.firebaseapp.com",
  databaseURL: "https://kyky-c3471-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "kyky-c3471",
  storageBucket: "kyky-c3471.appspot.com",
  messagingSenderId: "658643330578",
  appId: "1:658643330578:web:758dc26d5504a503e39acb"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ================= STATE =================
let pseudo = "";
let freq = "1220-80";
let listening = false;
let autoTranslate = true;   // ← ICI

  // slider et label pour fréquence
const freqSlider = document.getElementById('freqSlider');
const freqLabel  = document.getElementById('freqLabel');
const freqDisplay = document.getElementById('freqDisplay');



// ================= AUDIO =================
const AudioCtx = window.AudioContext || window.webkitAudioContext;
const audioCtx = new AudioCtx();

const DOT = 60;
const DASH = DOT * 3;

const LETTER_GAP_TIME = DOT * 6;   // au lieu de 12
const WORD_GAP_TIME   = DOT * 18;   // au lieu de 3000 ms

const translateCheckbox = document.getElementById('translateMode');

translateCheckbox.addEventListener('change', () => {
  autoTranslate = translateCheckbox.checked;
});

// ================= CANVAS =================
const tx = document.getElementById('tx').getContext('2d');
const receptionDivContainer = document.getElementById('receptionText');

let userBuffers = {};   // pseudo => { current, output }
let userCanvases = {};  // pseudo => ctx

  
// ================= AUDIO =================
function playTone(freq, dur){
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.frequency.value = freq;
  gain.gain.value = 0.25;
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime + dur / 1000);
}
function updateFreqDisplay() {
  const val = parseFloat(freqSlider.value).toFixed(3);
  freqLabel.textContent = val;
  freqDisplay.textContent = val + " MHz";
}

// mise à jour quand on bouge le slider
freqSlider.addEventListener('input', updateFreqDisplay);

// bouton +
document.getElementById('freqPlus').addEventListener('click', () => {
  let val = parseFloat(freqSlider.value);
  val = Math.min(val + 1, parseFloat(freqSlider.max)); // ne dépasse pas max
  freqSlider.value = val.toFixed(3);
  updateFreqDisplay();
});

// bouton -
document.getElementById('freqMinus').addEventListener('click', () => {
  let val = parseFloat(freqSlider.value);
  val = Math.max(val - 1, parseFloat(freqSlider.min)); // ne descend pas en dessous de min
  freqSlider.value = val.toFixed(3);
  updateFreqDisplay();
});
// ================= NOISE =================
let noiseSource = null;
let noiseGain = null;

function startNoise(){
  if(noiseSource) return;

  const bufferSize = audioCtx.sampleRate * 2;
  const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
  const data = buffer.getChannelData(0);

  for(let i=0;i<data.length;i++){
    data[i] = (Math.random()*2 - 1) * 0.12;
  }

  noiseSource = audioCtx.createBufferSource();
  noiseSource.buffer = buffer;
  noiseSource.loop = true;

  noiseGain = audioCtx.createGain();
  noiseGain.gain.value = 0.05;

  noiseSource.connect(noiseGain);
  noiseGain.connect(audioCtx.destination);
  noiseSource.start();
}

function stopNoise(){
  if(noiseSource){
    noiseSource.stop();
    noiseSource.disconnect();
    noiseGain.disconnect();
    noiseSource = null;
    noiseGain = null;
  }
}

// ================= CANVAS =================
function scroll(ctx){
  const img = ctx.getImageData(2,0,ctx.canvas.width-2,ctx.canvas.height);
  ctx.putImageData(img,0,0);
  ctx.clearRect(ctx.canvas.width-2,0,2,ctx.canvas.height);
}

function drawNoise(ctx){
  ctx.fillStyle = '#002';
  ctx.fillRect(ctx.canvas.width-2,0,2,ctx.canvas.height);
}

function drawSignal(ctx, strength){
  ctx.fillStyle = '#0af';

  // trait vertical fin, centré
  ctx.fillRect(
    ctx.canvas.width - 2,
    ctx.canvas.height - strength,
    2,
    strength
  );
}



setInterval(()=>{
  scroll(tx);
  for(const u in userCanvases){
    scroll(userCanvases[u]);
    drawNoise(userCanvases[u]);
  }
},40);

// ================= UI =================
function enterRadio(){
  pseudo = document.getElementById('pseudoInput').value.trim();
  freq = parseFloat(freqSlider.value).toFixed(3).replace(/\./g,'-'); // ex: 122.800 → 122-800
  if(!pseudo || !freq) return;
  document.getElementById('popup').style.display='none';
  if(!listening) startListening();
}

// ================= MORSE MAP =================
const morseCodeMap = {
  '.-':'A','-...':'B','-.-.':'C','-..':'D','.':'E','..-.':'F','--.':'G',
  '....':'H','..':'I','.---':'J','-.-':'K','.-..':'L','--':'M','-.':'N',
  '---':'O','.--.':'P','--.-':'Q','.-.':'R','...':'S','-':'T','..-':'U',
  '...-':'V','.--':'W','-..-':'X','-.--':'Y','--..':'Z',
  '-----':'0','.----':'1','..---':'2','...--':'3','....-':'4',
  '.....':'5','-....':'6','--...':'7','---..':'8','----.':'9',
  '.-.-.-':'.','--..--':',','..--..':'?','/':' '
};

function translateMorse(code){
  return morseCodeMap[code] || '?';
}

// ================= AUTO-TRANSLATE =================
function createUserDiv(sender){
  const div = document.createElement('div');
  div.id = `receptionText-${sender}`;
  div.style.marginTop = '10px';
  div.style.fontSize = '20px';
  div.innerHTML = `<strong>${sender}:</strong> `;
  receptionDivContainer.appendChild(div);
  return div;
}

function createUserCanvas(sender){
  const canvas = document.createElement('canvas');
  canvas.width = 1200;
  canvas.height = 120;
  canvas.style.background = '#111';
  document.body.appendChild(canvas);
  return canvas.getContext('2d');
}

function updateTranslation(sender){
  if(!autoTranslate) return;

  const buf = userBuffers[sender];
  const div = document.getElementById(`receptionText-${sender}`) || createUserDiv(sender);
  const txt = buf.output.map(c => translateMorse(c)).join('');
  div.innerHTML = `<strong>${sender}:</strong> ${txt}`;

  // Vérifie si SOS a été envoyé
  checkSOS(sender);
}


function checkSOS(sender){
  const buf = userBuffers[sender];
  if(!buf) return;

  // récupérer le texte traduit en majuscule
  const txt = buf.output.map(c => translateMorse(c)).join('').toUpperCase();

  // si SOS détecté → lancer alarme
  if(txt.includes("SOS")){
    startSOSAlarm();
  }
}

  let sosOsc = null;
let sosGain = null;

function startSOSAlarm(){
  if(sosOsc) return; // déjà en cours

  const freqs = [880, 660, 880]; // exemple : bip montant/descendant
  let i = 0;

  sosOsc = audioCtx.createOscillator();
  sosGain = audioCtx.createGain();

  sosOsc.type = 'square';
  sosOsc.frequency.value = freqs[i];
  sosGain.gain.value = 0.3;

  sosOsc.connect(sosGain);
  sosGain.connect(audioCtx.destination);
  sosOsc.start();

  // changer fréquence toutes les 200ms pour faire un "bip SOS"
  sosOsc.interval = setInterval(()=>{
    i = (i+1)%freqs.length;
    sosOsc.frequency.setValueAtTime(freqs[i], audioCtx.currentTime);
  }, 200);
}

  function stopSOSAlarm(){
  if(!sosOsc) return;

  clearInterval(sosOsc.interval);
  sosOsc.stop();
  sosOsc.disconnect();
  sosGain.disconnect();

  sosOsc = null;
  sosGain = null;
}


// ================= EMISSION =================
let letterTimer = null;
let wordTimer = null;

function emit(char){
  const dur = char==='-' ? DASH : DOT;
  playTone(1250,dur);
  drawSignal(tx,char==='-'?80:40);

  db.ref(`${freq}/chats/emissions/MESSAGE`).push({
    type:'signal',
    char,
    by:pseudo,
    t:Date.now()
  });

  clearTimeout(letterTimer);
  clearTimeout(wordTimer);

  letterTimer = setTimeout(()=>{
    db.ref(`${freq}/chats/emissions/MESSAGE`).push({
      type:'letter_gap',
      by:pseudo,
      t:Date.now()
    });
  }, LETTER_GAP_TIME);

  wordTimer = setTimeout(()=>{
    db.ref(`${freq}/chats/emissions/MESSAGE`).push({
      type:'word_gap',
      by:pseudo,
      t:Date.now()
    });
  }, WORD_GAP_TIME);
}

// ================= RECEPTION =================
function startListening(){
  listening = true;
  let lastRx = 0;

  db.ref(`${freq}/chats/emissions/MESSAGE`).on('child_added', snap=>{
    const d = snap.val();
    if(!d || !d.by) return;

    if(!userBuffers[d.by]){
      userBuffers[d.by]={ current:'', output:[] };
    }
    if(!userCanvases[d.by]){
      userCanvases[d.by]=createUserCanvas(d.by);
    }

    if(d.type==='signal'){
  userBuffers[d.by].current += d.char;

  if(d.by!==pseudo){
    playTone(800, d.char==='-'?DASH:DOT);

    // ⏱️ Décalage visuel pour éviter que les caractères se collent
    setTimeout(()=>{
      drawSignal(
        userCanvases[d.by],
        d.char === '-' ? 80 : 40
      );
    }, 80); // ← ajuste 60–120 ms si besoin

    startNoise();
    lastRx = Date.now();
  }
}


    if(d.type==='letter_gap'){
      const buf=userBuffers[d.by];
      if(buf.current){
        buf.output.push(buf.current);
        buf.current='';
        updateTranslation(d.by);
      }
    }

    if(d.type==='word_gap'){
      const buf=userBuffers[d.by];
      if(buf.current){
        buf.output.push(buf.current);
        buf.current='';
      }
      buf.output.push('/');
      updateTranslation(d.by);
    }
  });

  setInterval(()=>{
    if(Date.now()-lastRx>5000) stopNoise();
  },1000);
}

// ================= CLEAR =================
function clearTranslation(){
  for(const u in userBuffers){
    userBuffers[u].current='';
    userBuffers[u].output=[];
    const div=document.getElementById(`receptionText-${u}`);
    if(div) div.innerHTML=`<strong>${u}:</strong> `;
  }

  // Supprime les messages sur Firebase pour cette fréquence
  db.ref(`${freq}/chats/emissions/MESSAGE`).remove();

  // Arrête l'alarme SOS si elle était active
  stopSOSAlarm();
}

</script>





</body>
</html>
