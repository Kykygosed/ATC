<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Morse Radio – Spectrogramme</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
body{margin:0;background:#0b0b0b;color:#fff;font-family:Arial;touch-action: manipulation;}
#popup{position:fixed;inset:0;background:#000c;display:flex;align-items:center;justify-content:center;z-index:10}
#popup input,#popup button{font-size:18px;padding:10px}
#top{text-align:center;padding:15px}
#freqInput{font-size:40px;text-align:center;border:2px solid #fff;background:#000;color:#fff;width:240px}
canvas{width:100%;height:140px;background:#1b1b1b;display:block}
.label{margin:6px;opacity:.7}
#controls{display:flex;justify-content:center;gap:40px;padding:20px}
.btn{width:120px;height:80px;font-size:36px;border:none;color:#fff;cursor:pointer;touch-action: manipulation;}
.dot{background:#c00}
.dash{background:#0c0}
#receptionText {text-align:center; font-size:24px; min-height:140px; line-height:1.4;}
#autoTranslate {margin-top:10px;}
#clearBtn {margin-left:20px;font-size:16px;padding:5px 10px;cursor:pointer;}
</style>
</head>
<body>

<div id="popup">
  <div>
    <input id="pseudoInput" placeholder="Pseudo"><br><br>
    <button onclick="enterRadio()">Entrer</button>
  </div>
</div>

<div id="top">
  <input id="freqInput" value="1220-80">
  <div class="label">Émission ↓</div>
</div>

<canvas id="tx" width="1200" height="140"></canvas>
<div class="label">Réception ↓</div>
<canvas id="rx" width="1200" height="140"></canvas>
<div id="receptionText"></div>
<label id="autoTranslate">
  <input type="checkbox" id="translateMode"> Mode auto traduction
</label>
<button id="clearBtn" onclick="clearTranslation()">Clear</button>

<div id="controls">
  <button class="btn dot" onmousedown="emit('.')">•</button>
  <button class="btn dash" onmousedown="emit('-')">—</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
// ================= FIREBASE =================
const firebaseConfig = {
  apiKey: "AIzaSyDxDzLbCnqYYVknoyHMzbE0gB_SRVLpgiw",
  authDomain: "kyky-c3471.firebaseapp.com",
  databaseURL: "https://kyky-c3471-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "kyky-c3471",
  storageBucket: "kyky-c3471.appspot.com",
  messagingSenderId: "658643330578",
  appId: "1:658643330578:web:758dc26d5504a503e39acb"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ================= STATE =================
let pseudo = "";
let freq = "1220-80";
let listening = false;

// ================= AUDIO =================
const AudioCtx = window.AudioContext || window.webkitAudioContext;
const audioCtx = new AudioCtx();
const DOT = 60;
const DASH = DOT * 3;

// Bruit de fond pour récepteur
let noiseGain = null;
let noiseOscillator = null;
let listeningUsers = {}; // pseudo => actif

// ================= CANVAS =================
const tx = document.getElementById('tx').getContext('2d');
const receptionDivContainer = document.getElementById('receptionText');

// Buffers par utilisateur
let userBuffers = {}; // pseudo => {morseCurrentLetter, morseWordBuffer, lastReceivedTime}
let userCanvases = {}; // pseudo => ctx

function playTone(frequency, duration) {
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.frequency.value = frequency;
  gain.gain.value = 0.25;
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime + duration / 1000);
}

// Canvas TX
function scroll(ctx) {
  const img = ctx.getImageData(2,0,ctx.canvas.width-2, ctx.canvas.height);
  ctx.putImageData(img,0,0);
  ctx.clearRect(ctx.canvas.width-2,0,2,ctx.canvas.height);
}

// Canvas RX par utilisateur
function scrollRXUsers(){
  for(let user in userCanvases){
    const ctx = userCanvases[user];
    const img = ctx.getImageData(2,0,ctx.canvas.width-2, ctx.canvas.height);
    ctx.putImageData(img,0,0);
    ctx.clearRect(ctx.canvas.width-2,0,2,ctx.canvas.height);
    drawNoise(ctx);
  }
}

// bruit léger
function drawNoise(ctx){
  ctx.fillStyle = '#003';
  ctx.fillRect(ctx.canvas.width-2,0,2,ctx.canvas.height);
}

function drawSignal(ctx,strength){
  ctx.fillStyle = '#0af';
  ctx.fillRect(ctx.canvas.width-2,ctx.canvas.height-strength,2,strength);
}

setInterval(()=>{
  scroll(tx);
  scrollRXUsers();
},40);

// ================= UI =================
function enterRadio(){
  pseudo = document.getElementById('pseudoInput').value.trim();
  freq = document.getElementById('freqInput').value.trim().replace(/\./g,'-');
  if(!pseudo||!freq) return;
  document.getElementById('popup').style.display='none';
  if(!listening) startListening();
}

// ================= EMISSION =================
function emit(char){
  const dur = char==='-'?DASH:DOT;
  playTone(1250,dur);
  drawSignal(tx,char==='-'?80:40);

  // Envoyer à Firebase
  db.ref(`${freq}/chats/emissions/MESSAGE`).push({
    char,
    dur,
    by: pseudo,
    t: Date.now()
  });

  // Auto-translate côté local pour notre émission
  if(document.getElementById('translateMode').checked){
    processReceivedMorse(char,dur,pseudo);
  }
}

// ================= AUTO-TRANSLATE =================
const morseCodeMap = {
  // Lettres
  '.-':'A','-...':'B','-.-.':'C','-..':'D','.':'E','..-.':'F','--.':'G','....':'H','..':'I',
  '.---':'J','-.-':'K','.-..':'L','--':'M','-.':'N','---':'O','.--.':'P','--.-':'Q','.-.':'R',
  '...':'S','-':'T','..-':'U','...-':'V','.--':'W','-..-':'X','-.--':'Y','--..':'Z',
  // Chiffres
  '-----':'0','.----':'1','..---':'2','...--':'3','....-':'4','.....':'5','-....':'6',
  '--...':'7','---..':'8','----.':'9',
  // Ponctuation
  '.-.-.-':'.','--..--':',','..--..':'?'
};

const letterThreshold = 6*DOT;
const wordThreshold = 10*DOT;

// Traduction par utilisateur
function processReceivedMorse(char,dur,sender){
  if(!userBuffers[sender]) userBuffers[sender]={morseCurrentLetter:'',morseWordBuffer:[],lastReceivedTime:0};
  if(!userCanvases[sender]) userCanvases[sender]=createUserCanvas(sender);
  if(!listeningUsers[sender]) { listeningUsers[sender]=true; startNoise(); }

  const buf=userBuffers[sender];
  const now=Date.now();
  const delta=buf.lastReceivedTime?now-buf.lastReceivedTime:0;
  buf.lastReceivedTime=now;

  // Fin de mot
  if(delta>=wordThreshold){
    if(buf.morseCurrentLetter){
      updateTranslationForUser(sender,true,true);
    }
    buf.morseCurrentLetter='';
    buf.morseWordBuffer.push([]);
  }
  // Fin de lettre
  else if(delta>=letterThreshold){
    if(buf.morseCurrentLetter) updateTranslationForUser(sender,true);
    buf.morseCurrentLetter='';
  }

  buf.morseCurrentLetter+=char;
  updateTranslationForUser(sender);
  scheduleTranslationForUser(sender);
}

function translateMorse(morse){
  if(morseCodeMap[morse]) return morseCodeMap[morse];
  return '?';
}

function updateTranslationForUser(sender,force=false,isWord=false){
  const buf=userBuffers[sender];
  if(force && buf.morseCurrentLetter){
    buf.morseWordBuffer.push([buf.morseCurrentLetter]);
    buf.morseCurrentLetter='';
  }
  let translated=buf.morseWordBuffer.map((letterArr,idx)=>{
    let chars=letterArr.map(c=>translateMorse(c)).join('');
    if(isWord && idx===buf.morseWordBuffer.length-1) chars+=' u';
    return chars;
  }).join(' ');

  const div=document.getElementById(`receptionText-${sender}`) || createUserDiv(sender);
  div.innerText=translated;
}

function scheduleTranslationForUser(sender){
  const buf=userBuffers[sender];
  if(buf.translationTimer) clearTimeout(buf.translationTimer);
  buf.translationTimer=setTimeout(()=>updateTranslationForUser(sender,true),letterThreshold);
}

function createUserDiv(sender){
  const div=document.createElement('div');
  div.id=`receptionText-${sender}`;
  div.style.marginTop='10px';
  div.style.fontSize='20px';
  div.style.minHeight='30px';
  receptionDivContainer.appendChild(div);
  return div;
}

function createUserCanvas(sender){
  const canvas=document.createElement('canvas');
  canvas.width=1200;
  canvas.height=140;
  canvas.style.display='block';
  canvas.style.background='#1b1b1b';
  document.body.appendChild(canvas);
  return canvas.getContext('2d');
}

function clearTranslation(){
  for(let sender in userBuffers){
    userBuffers[sender].morseCurrentLetter='';
    userBuffers[sender].morseWordBuffer=[];
    const div=document.getElementById(`receptionText-${sender}`);
    if(div) div.innerText='';
  }
}

// ================= BRUIT DE FOND =================
function startNoise(){
  if(noiseOscillator) return;
  const bufferSize=2*audioCtx.sampleRate;
  const noiseBuffer=audioCtx.createBuffer(1,bufferSize,audioCtx.sampleRate);
  const output=noiseBuffer.getChannelData(0);
  for(let i=0;i<bufferSize;i++) output[i]=(Math.random()*2-1)*0.2;

  const noiseSource=audioCtx.createBufferSource();
  noiseSource.buffer=noiseBuffer;
  noiseSource.loop=true;

  const gainNode=audioCtx.createGain();
  gainNode.gain.value=0.05;

  noiseSource.connect(gainNode);
  gainNode.connect(audioCtx.destination);

  noiseSource.start();
  noiseOscillator=noiseSource;
  noiseGain=gainNode;
}

function stopNoise(){
  if(noiseOscillator){
    noiseOscillator.stop();
    noiseOscillator.disconnect();
    noiseGain.disconnect();
    noiseOscillator=null;
    noiseGain=null;
  }
}

// ================= RECEPTION =================
function startListening(){
  listening=true;
  let lastTime=0;

  const userRef=db.ref(`${freq}/chats/emissions/MESSAGE`);
  userRef.on('child_added',snap=>{
    const d=snap.val();
    if(!d||!d.by) return;
    if(d.by===pseudo) return;

    processReceivedMorse(d.char,d.dur,d.by);

    if(d.t<=lastTime) return;
    lastTime=d.t;

    playTone(800,d.dur);
    drawSignal(userCanvases[d.by],d.char==='-'?80:40);
  });

  // Vérifier si utilisateur inactif
  setInterval(()=>{
    const now=Date.now();
    let active=false;
    for(let u in userBuffers){
      if(now-userBuffers[u].lastReceivedTime<5000) active=true;
    }
    if(!active) stopNoise();
  },1000);
}
</script>

</body>
</html>
