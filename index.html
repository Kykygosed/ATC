<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Morse Radio – Spectrogramme</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
body{margin:0;background:#0b0b0b;color:#fff;font-family:Arial;touch-action: manipulation;}
#popup{position:fixed;inset:0;background:#000c;display:flex;align-items:center;justify-content:center;z-index:10}
#popup input,#popup button{font-size:18px;padding:10px}
#top{text-align:center;padding:15px}
#freqInput{font-size:40px;text-align:center;border:2px solid #fff;background:#000;color:#fff;width:240px}
canvas{width:100%;height:140px;background:#1b1b1b;display:block}
.label{margin:6px;opacity:.7}
#controls{display:flex;justify-content:center;gap:40px;padding:20px}
.btn{width:120px;height:80px;font-size:36px;border:none;color:#fff;cursor:pointer;touch-action: manipulation;}
.dot{background:#c00}
.dash{background:#0c0}
#receptionText {text-align:center; font-size:24px; min-height:140px; line-height:1.4;}
#autoTranslate {margin-top:10px;}
#clearBtn {margin-left:20px;font-size:16px;padding:5px 10px;cursor:pointer;}
</style>
</head>
<body>

<div id="popup">
  <div>
    <input id="pseudoInput" placeholder="Pseudo"><br><br>
    <button onclick="enterRadio()">Entrer</button>
  </div>
</div>

<div id="top">
  <input id="freqInput" value="1220-80">
  <div class="label">Émission ↓</div>
</div>

<canvas id="tx" width="1200" height="140"></canvas>
<div class="label">Réception ↓</div>
<canvas id="rx" width="1200" height="140"></canvas>
<div id="receptionText"></div>
<label id="autoTranslate">
  <input type="checkbox" id="translateMode"> Mode auto traduction
</label>
<button id="clearBtn" onclick="clearTranslation()">Clear</button>

<div id="controls">
  <button class="btn dot" onmousedown="emit('.')">•</button>
  <button class="btn dash" onmousedown="emit('-')">—</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
// ================= FIREBASE =================
// ================= FIREBASE =================
const firebaseConfig = {
  apiKey: "AIzaSyDxDzLbCnqYYVknoyHMzbE0gB_SRVLpgiw",
  authDomain: "kyky-c3471.firebaseapp.com",
  databaseURL: "https://kyky-c3471-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "kyky-c3471",
  storageBucket: "kyky-c3471.appspot.com",
  messagingSenderId: "658643330578",
  appId: "1:658643330578:web:758dc26d5504a503e39acb"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ================= STATE =================
let pseudo = "";
let freq = "1220-80";
let listening = false;

// ================= AUDIO =================
const AudioCtx = window.AudioContext || window.webkitAudioContext;
const audioCtx = new AudioCtx();

const DOT = 60;
const DASH = DOT * 3;
const LETTER_GAP = DOT * 9;
const SILENCE_SLASH_TIME = 3000;

// Bruit de fond
let noiseOscillator = null;
let noiseGain = null;

// ================= CANVAS =================
const tx = document.getElementById('tx').getContext('2d');
const receptionDivContainer = document.getElementById('receptionText');

let userBuffers = {};   // pseudo => buffer
let userCanvases = {};  // pseudo => ctx

// ================= AUDIO =================
function playTone(freq, dur){
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.frequency.value = freq;
  gain.gain.value = 0.25;
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime + dur / 1000);
}

// ================= CANVAS =================
function scroll(ctx){
  const img = ctx.getImageData(2,0,ctx.canvas.width-2,ctx.canvas.height);
  ctx.putImageData(img,0,0);
  ctx.clearRect(ctx.canvas.width-2,0,2,ctx.canvas.height);
}

function drawNoise(ctx){
  ctx.fillStyle = '#003';
  ctx.fillRect(ctx.canvas.width-2,0,2,ctx.canvas.height);
}

function drawSignal(ctx,strength){
  ctx.fillStyle = '#0af';
  ctx.fillRect(ctx.canvas.width-2,ctx.canvas.height-strength,2,strength);
}

setInterval(()=>{
  scroll(tx);
  for(const u in userCanvases){
    scroll(userCanvases[u]);
    drawNoise(userCanvases[u]);
  }
},40);

// ================= UI =================
function enterRadio(){
  pseudo = document.getElementById('pseudoInput').value.trim();
  freq = document.getElementById('freqInput').value.trim().replace(/\./g,'-');
  if(!pseudo||!freq) return;
  document.getElementById('popup').style.display='none';
  if(!listening) startListening();
}

// ================= EMISSION =================
function emit(char){
  const dur = char==='-' ? DASH : DOT;
  playTone(1250,dur);
  drawSignal(tx,char==='-'?80:40);

  db.ref(`${freq}/chats/emissions/MESSAGE`).push({
    char,
    dur,
    by:pseudo,
    t:Date.now()
  });

  if(document.getElementById('translateMode')?.checked){
    processReceivedMorse(char,pseudo);
  }
}

// ================= MORSE MAP =================
const morseCodeMap = {
  '.-':'A','-...':'B','-.-.':'C','-..':'D','.':'E','..-.':'F','--.':'G',
  '....':'H','..':'I','.---':'J','-.-':'K','.-..':'L','--':'M','-.':'N',
  '---':'O','.--.':'P','--.-':'Q','.-.':'R','...':'S','-':'T','..-':'U',
  '...-':'V','.--':'W','-..-':'X','-.--':'Y','--..':'Z',
  '-----':'0','.----':'1','..---':'2','...--':'3','....-':'4',
  '.....':'5','-....':'6','--...':'7','---..':'8','----.':'9',
  '.-.-.-':'.','--..--':',','..--..':'?'
};

function translateMorse(code){
  if(code === '/') return '/';
  return morseCodeMap[code] || '?';
}

// ================= AUTO-TRANSLATE =================
function createUserDiv(sender){
  const div = document.createElement('div');
  div.id = `receptionText-${sender}`;
  div.style.marginTop = '10px';
  div.style.fontSize = '20px';
  div.innerHTML = `<strong>${sender}:</strong> `;
  receptionDivContainer.appendChild(div);
  return div;
}

function createUserCanvas(sender){
  const canvas = document.createElement('canvas');
  canvas.width = 1200;
  canvas.height = 140;
  canvas.style.background = '#1b1b1b';
  document.body.appendChild(canvas);
  return canvas.getContext('2d');
}

function updateTranslationForUser(sender){
  const buf = userBuffers[sender];
  const div = document.getElementById(`receptionText-${sender}`) || createUserDiv(sender);

  const translated = buf.output.map(c=>translateMorse(c)).join(' ');
  div.innerHTML = `<strong>${sender}:</strong> ${translated}`;
}

function processReceivedMorse(char,sender){
  if(!userBuffers[sender]){
    userBuffers[sender]={
      current:'',
      output:[],
      lastTime:0,
      slashAdded:false,
      timer:null
    };
  }

  if(!userCanvases[sender]){
    userCanvases[sender]=createUserCanvas(sender);
  }

  const buf = userBuffers[sender];
  const now = Date.now();
  const delta = buf.lastTime ? now - buf.lastTime : 0;
  buf.lastTime = now;

  // Silence long → /
  if(delta >= SILENCE_SLASH_TIME && !buf.slashAdded){
    buf.output.push('/');
    buf.slashAdded = true;
    updateTranslationForUser(sender);
  }

  buf.slashAdded = false;
  buf.current += char;

  clearTimeout(buf.timer);
  buf.timer = setTimeout(()=>{
    if(buf.current){
      buf.output.push(buf.current);
      buf.current='';
      updateTranslationForUser(sender);
    }
  },LETTER_GAP);
}

// ================= CLEAR =================
function clearTranslation(){
  for(const sender in userBuffers){
    userBuffers[sender].current='';
    userBuffers[sender].output=[];
    userBuffers[sender].slashAdded=false;
    const div=document.getElementById(`receptionText-${sender}`);
    if(div) div.innerHTML=`<strong>${sender}:</strong> `;
  }
}

// ================= BRUIT DE FOND =================
function startNoise(){
  if(noiseOscillator) return;

  const bufferSize = audioCtx.sampleRate * 2;
  const noiseBuffer = audioCtx.createBuffer(1,bufferSize,audioCtx.sampleRate);
  const data = noiseBuffer.getChannelData(0);

  for(let i=0;i<data.length;i++){
    data[i]=(Math.random()*2-1)*0.15;
  }

  noiseOscillator = audioCtx.createBufferSource();
  noiseOscillator.buffer = noiseBuffer;
  noiseOscillator.loop = true;

  noiseGain = audioCtx.createGain();
  noiseGain.gain.value = 0.05;

  noiseOscillator.connect(noiseGain);
  noiseGain.connect(audioCtx.destination);
  noiseOscillator.start();
}

function stopNoise(){
  if(noiseOscillator){
    noiseOscillator.stop();
    noiseOscillator.disconnect();
    noiseGain.disconnect();
    noiseOscillator=null;
    noiseGain=null;
  }
}

// ================= RECEPTION =================
function startListening(){
  listening=true;
  let lastRx=0;

  db.ref(`${freq}/chats/emissions/MESSAGE`).on('child_added',snap=>{
    const d=snap.val();
    if(!d||!d.by) return;
    if(d.by===pseudo) return;

    lastRx=Date.now();
    startNoise();

    playTone(800,d.dur);
    drawSignal(userCanvases[d.by],d.char==='-'?80:40);

    if(document.getElementById('translateMode')?.checked){
      processReceivedMorse(d.char,d.by);
    }
  });

  setInterval(()=>{
    if(Date.now()-lastRx>5000) stopNoise();
  },1000);
}

</script>

</body>
</html>
