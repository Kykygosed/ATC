<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Transpondeur</title>
<style>
  @font-face {
    font-family: 'DS-DIGITAL';
    src: url('https://fonts.cdnfonts.com/s/18310/DS-DIGI.TTF') format('truetype');
  }
  body {
    background: #000;
    color: #0f0;
    font-family: 'DS-DIGITAL', monospace;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    margin: 0;
  }
  #squawk-display {
    font-size: 4em;
    border: 2px solid #0f0;
    padding: 10px 20px;
    margin-bottom: 20px;
    width: 200px;
    text-align: center;
    letter-spacing: 10px;
  }
  #keypad {
    display: grid;
    grid-template-columns: repeat(3, 70px);
    gap: 10px;
  }
  button {
    font-size: 2em;
    background: #111;
    color: #0f0;
    border: 2px solid #0f0;
    border-radius: 5px;
    cursor: pointer;
  }
  button:active {
    background: #0f0;
    color: #000;
  }
</style>
</head>
<body>

<div id="squawk-display">0000</div>
<div id="keypad">
  <button>0</button><button>1</button><button>2</button>
  <button>3</button><button>4</button><button>5</button>
  <button>6</button><button>7</button><button>Clear</button>
  <button>Enter</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<script>
  // Config Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyBPq6Wfxzq02MfK69BFxHm9_FUjDGTmAcw",
    authDomain: "kykychat-24c7f.firebaseapp.com",
    databaseURL: "https://kykychat-24c7f-default-rtdb.firebaseio.com",
    projectId: "kykychat-24c7f",
    storageBucket: "kykychat-24c7f.firebasestorage.app",
    messagingSenderId: "342562811927",
    appId: "1:342562811927:web:0fed1e1f511c4fddcfec52"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let callsign = null;
  let squawk = "0000";
  let position = null;
  let altitude = 30000; // exemple
  let vitesse = 450;    // exemple en noeuds

  // Demander callsign
  function askCallsign() {
    let cs = prompt("Entrez votre callsign (ex: ABC123)");
    if (!cs || cs.trim().length === 0) return askCallsign();
    callsign = cs.trim().toUpperCase();
  }

  // Demander géolocalisation
  function askLocation() {
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) {
        alert("Géolocalisation non supportée.");
        resolve(null);
      } else {
        navigator.geolocation.getCurrentPosition(
          pos => {
            resolve({
              lat: pos.coords.latitude,
              lon: pos.coords.longitude
            });
          },
          err => {
            alert("Impossible d'accéder à la position.");
            resolve(null);
          }
        );
      }
    });
  }

  askCallsign();

  askLocation().then(pos => {
    position = pos;

    // Initial push sur Firebase
    updateFirebase();

    // Afficher squawk initial
    document.getElementById('squawk-display').textContent = squawk;
  });

  // Gestion clavier
  const display = document.getElementById('squawk-display');
  const buttons = document.querySelectorAll('#keypad button');

  buttons.forEach(button => {
    button.addEventListener('click', () => {
      let val = button.textContent;

      if (val === "Clear") {
        squawk = "0000";
      } else if (val === "Enter") {
        updateFirebase();
        alert("Squawk mis à jour: " + squawk);
      } else {
        // On ajoute si moins de 4 chiffres
        if (squawk.length < 4) {
          // Remplacer le premier zéro de gauche
          squawk = (squawk + val).slice(-4);
        }
      }
      display.textContent = squawk;
    });
  });

  function updateFirebase() {
    if (!callsign) return;
    db.ref('transpondeurs/' + callsign).set({
      squawk,
      callsign,
      position,
      altitude,
      vitesse
    });
  }
</script>

</body>
</html>
