<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Morse Radio – Spectrogramme</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
body{margin:0;background:#0b0b0b;color:#fff;font-family:Arial;touch-action: manipulation;}
#popup{position:fixed;inset:0;background:#000c;display:flex;align-items:center;justify-content:center;z-index:10}
#popup input,#popup button{font-size:18px;padding:10px}
#top{text-align:center;padding:15px}
#freqInput{font-size:40px;text-align:center;border:2px solid #fff;background:#000;color:#fff;width:240px}
canvas{width:100%;height:140px;background:#1b1b1b;display:block}
.label{margin:6px;opacity:.7}
#controls{display:flex;justify-content:center;gap:40px;padding:20px}
.btn{width:120px;height:80px;font-size:36px;border:none;color:#fff;cursor:pointer;touch-action: manipulation;}
.dot{background:#c00}
.dash{background:#0c0}
#receptionText {text-align:center; font-size:24px; min-height:140px; line-height:1.4;}
#autoTranslate {margin-top:10px;}
#clearBtn {margin-left:20px;font-size:16px;padding:5px 10px;cursor:pointer;}
</style>
</head>
<body>

<div id="popup">
  <div>
    <input id="pseudoInput" placeholder="Pseudo"><br><br>
    <button onclick="enterRadio()">Entrer</button>
  </div>
</div>

<div id="top">
  <input id="freqInput" value="1220-80">
  <div class="label">Émission ↓</div>
</div>

<canvas id="tx" width="1200" height="140"></canvas>
<div class="label">Réception ↓</div>
<canvas id="rx" width="1200" height="140"></canvas>
<div id="receptionText"></div>
<label id="autoTranslate">
  <input type="checkbox" id="translateMode"> Mode auto traduction
</label>
<button id="clearBtn" onclick="clearTranslation()">Clear</button>

<div id="controls">
  <button class="btn dot" onmousedown="emit('.')">•</button>
  <button class="btn dash" onmousedown="emit('-')">—</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
// ================= FIREBASE =================
const firebaseConfig = {
  apiKey: "AIzaSyDxDzLbCnqYYVknoyHMzbE0gB_SRVLpgiw",
  authDomain: "kyky-c3471.firebaseapp.com",
  databaseURL: "https://kyky-c3471-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "kyky-c3471",
  storageBucket: "kyky-c3471.appspot.com",
  messagingSenderId: "658643330578",
  appId: "1:658643330578:web:758dc26d5504a503e39acb"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ================= STATE =================
let pseudo = "";
let freq = "1220-80";
let listening = false;

// ================= AUDIO =================
const AudioCtx = window.AudioContext || window.webkitAudioContext;
const audioCtx = new AudioCtx();
const DOT = 60;
const DASH = DOT * 3;

// Bruit de fond pour récepteur
let noiseGain = null;
let noiseOscillator = null;
let listeningUsers = 0;

// ================= CANVAS =================
const tx = document.getElementById('tx').getContext('2d');
const rx = document.getElementById('rx').getContext('2d');
const receptionDiv = document.getElementById('receptionText');

function playTone(frequency, duration) {
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.frequency.value = frequency;
  gain.gain.value = 0.25;
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime + duration / 1000);
}

// Canvas TX
function scroll(ctx) {
  const img = ctx.getImageData(2, 0, ctx.canvas.width - 2, ctx.canvas.height);
  ctx.putImageData(img, 0, 0);
  ctx.clearRect(ctx.canvas.width - 2, 0, 2, ctx.canvas.height);
}

// Canvas RX
function scrollRX() {
  if(listeningUsers === 0) return; // ne défile que si quelqu'un est connecté
  const img = rx.getImageData(2, 0, rx.canvas.width - 2, rx.canvas.height);
  rx.putImageData(img, 0, 0);
  rx.clearRect(rx.canvas.width - 2, 0, 2, rx.canvas.height);
  // bruit de fond
  drawNoise(rx);
}

function drawNoise(ctx) {
  ctx.fillStyle = '#003';
  ctx.fillRect(ctx.canvas.width - 2, 0, 2, ctx.canvas.height);
}

function drawSignal(ctx, strength) {
  ctx.fillStyle = '#0af';
  ctx.fillRect(ctx.canvas.width - 2, ctx.canvas.height - strength, 2, strength);
}

setInterval(() => {
  scroll(tx);
  scrollRX();
}, 40);

// ================= UI =================
function enterRadio() {
  pseudo = document.getElementById('pseudoInput').value.trim();
  freq = document.getElementById('freqInput').value.trim().replace(/\./g, '-');
  if (!pseudo || !freq) return;
  document.getElementById('popup').style.display = 'none';
  if (!listening) startListening();
}

// ================= EMISSION =================
function emit(char) {
  const dur = char === '-' ? DASH : DOT;
  playTone(1250, dur);
  drawSignal(tx, char === '-' ? 80 : 40);

  db.ref(`${freq}/chats/emissions/MESSAGE`).push({
    char,
    dur,
    by: pseudo,
    t: Date.now()
  });
}

// ================= AUTO-TRANSLATE =================
const morseCodeMap = {
  // Lettres
  '.-':'A','-...':'B','-.-.':'C','-..':'D','.':'E','..-.':'F','--.':'G','....':'H','..':'I',
  '.---':'J','-.-':'K','.-..':'L','--':'M','-.':'N','---':'O','.--.':'P','--.-':'Q','.-.':'R',
  '...':'S','-':'T','..-':'U','...-':'V','.--':'W','-..-':'X','-.--':'Y','--..':'Z',
  
  // Chiffres
  '-----':'0','.----':'1','..---':'2','...--':'3','....-':'4','.....':'5','-....':'6',
  '--...':'7','---..':'8','----.':'9',
  
  // Ponctuation (codes complets pour éviter conflit avec lettres)
  '.-.-.-':'.',   // point
  '--..--':',',   // virgule
  '..--..':'?'    // point d'interrogation
};


let morseCurrentLetter = "";
let morseWordBuffer = [];
let lastReceivedTime = 0;
let translationTimer = null;

const letterThreshold = 6 * DOT;
const wordThreshold = 10 * DOT;

function updateTranslation(force=false, isWord=false) {
  if(!document.getElementById('translateMode').checked) return;

  if(force && morseCurrentLetter){
    morseWordBuffer.push([morseCurrentLetter]);
    morseCurrentLetter = "";
  }

  // Construction du texte avec espaces "u" entre les mots
  let translated = morseWordBuffer.map((letterArr, idx) => {
    let chars = letterArr.map(c => morseCodeMap[c] || '?').join('');
    if(isWord && idx === morseWordBuffer.length-1) chars += ' u';
    return chars;
  }).join(' ');

  receptionDiv.innerText = translated;
}

function scheduleTranslation() {
  if(translationTimer) clearTimeout(translationTimer);
  translationTimer = setTimeout(() => {
    updateTranslation(true);
  }, letterThreshold);
}

function processReceivedMorse(char, dur) {
  const now = Date.now();
  const delta = lastReceivedTime ? now - lastReceivedTime : 0;
  lastReceivedTime = now;

  // Fin de mot
  if(delta >= wordThreshold){
    if(morseCurrentLetter){
      // on traduit la lettre actuelle et ajoute un espace pour mot
      updateTranslation(true, true); // force=true, isWord=true
    }
    morseCurrentLetter = "";
    // Ajout d’un "nouvel espace" pour le prochain mot
    morseWordBuffer.push([]); // crée un nouveau tableau pour le prochain mot
  }
  // Fin de lettre
  else if(delta >= letterThreshold){
    if(morseCurrentLetter) updateTranslation(true); // force=true
    morseCurrentLetter = "";
  }

  morseCurrentLetter += char;
  updateTranslation();
  scheduleTranslation();
}


function clearTranslation(){
  morseCurrentLetter = "";
  morseWordBuffer = [];
  receptionDiv.innerText = "";
}

// ================= BRUIT DE FOND =================
function startNoise() {
  if(noiseOscillator) return;

  // Création d'un buffer de bruit
  const bufferSize = 2 * audioCtx.sampleRate;
  const noiseBuffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
  const output = noiseBuffer.getChannelData(0);
  for (let i = 0; i < bufferSize; i++) {
    // bruit blanc + filtrage pour rendre plus doux
    output[i] = (Math.random() * 2 - 1) * 0.2; // amplitude réduite pour un grésillement agréable
  }

  const noiseSource = audioCtx.createBufferSource();
  noiseSource.buffer = noiseBuffer;
  noiseSource.loop = true;

  const gainNode = audioCtx.createGain();
  gainNode.gain.value = 0.05; // faible volume pour que ce soit agréable

  noiseSource.connect(gainNode);
  gainNode.connect(audioCtx.destination);

  noiseSource.start();
  noiseOscillator = noiseSource;
  noiseGain = gainNode;
}

function stopNoise() {
  if(noiseOscillator){
    noiseOscillator.stop();
    noiseOscillator.disconnect();
    noiseGain.disconnect();
    noiseOscillator = null;
    noiseGain = null;
  }
}



// ================= RECEPTION =================
function startListening() {
  listening = true;
  let lastTime = 0;

  // Détecter le nombre d'utilisateurs actifs
  const userRef = db.ref(`${freq}/chats/emissions/MESSAGE`);
  userRef.on('child_added', snap => {
    const d = snap.val();
    if (!d || d.by === pseudo) return;

    // Activer bruit et défilement si ce n'était pas déjà fait
    listeningUsers = 1;
    startNoise();

    if(d.t <= lastTime) return;
    lastTime = d.t;

    playTone(800, d.dur);
    drawSignal(rx, d.char === '-' ? 80 : 40);

    if(document.getElementById('translateMode').checked){
        processReceivedMorse(d.char, d.dur);
    }
  });

  // Vérifier si plus aucun utilisateur n'émet
  setInterval(() => {
    // On pourrait vérifier Firebase pour les messages récents et arrêter bruit si personne
    // Pour simplification, on arrête bruit si plus de child_added depuis 5s
    const now = Date.now();
    if(lastTime && now - lastTime > 5000){
      listeningUsers = 0;
      stopNoise();
    }
  }, 1000);
}
</script>
</body>
</html>
