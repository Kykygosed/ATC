<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Morse Radio – Stable</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
body{margin:0;background:#0b0b0b;color:#fff;font-family:Arial;touch-action: manipulation;}
#popup{position:fixed;inset:0;background:#000c;display:flex;align-items:center;justify-content:center;z-index:10}
#popup input,#popup button{font-size:18px;padding:10px}
#top{text-align:center;padding:15px}
#freqInput{font-size:40px;text-align:center;border:2px solid #fff;background:#000;color:#fff;width:240px}
canvas{width:100%;height:140px;background:#1b1b1b;display:block}
.label{margin:6px;opacity:.7}
#controls{display:flex;justify-content:center;gap:40px;padding:20px}
.btn{width:120px;height:80px;font-size:36px;border:none;color:#fff;cursor:pointer;touch-action: manipulation;}
.dot{background:#c00}
.dash{background:#0c0}
#receptionText {text-align:center; font-size:24px; min-height:140px; line-height:1.4;}
#autoTranslate {margin-top:10px;}
</style>
</head>
<body>

<div id="popup">
  <div>
    <input id="pseudoInput" placeholder="Pseudo"><br><br>
    <button onclick="enterRadio()">Entrer</button>
  </div>
</div>

<div id="top">
  <input id="freqInput" value="1220-80">
  <div class="label">Émission ↓</div>
</div>

<canvas id="tx" width="1200" height="140"></canvas>
<div class="label">Réception ↓</div>
<div id="receptionText"></div>
<label id="autoTranslate">
  <input type="checkbox" id="translateMode"> Mode auto traduction
</label>

<div id="controls">
  <button class="btn dot" onmousedown="emit('.')">•</button>
  <button class="btn dash" onmousedown="emit('-')">—</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
// ================= FIREBASE =================
const firebaseConfig = {
  apiKey: "AIzaSyDxDzLbCnqYYVknoyHMzbE0gB_SRVLpgiw",
  authDomain: "kyky-c3471.firebaseapp.com",
  databaseURL: "https://kyky-c3471-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "kyky-c3471",
  storageBucket: "kyky-c3471.firebasestorage.app",
  messagingSenderId: "658643330578",
  appId: "1:658643330578:web:758dc26d5504a503e39acb"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ================= STATE =================
let pseudo = "";
let freq = "1220-80";
let listening = false;

// ================= AUDIO =================
const AudioCtx = window.AudioContext || window.webkitAudioContext;
const audioCtx = new AudioCtx();
const DOT = 60;
const DASH = DOT * 3;

// ================= CANVAS =================
const tx = document.getElementById('tx').getContext('2d');
const receptionDiv = document.getElementById('receptionText');

function playTone(frequency, duration) {
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.frequency.value = frequency;
  gain.gain.value = 0.25;
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime + duration / 1000);
}

function scroll(ctx) {
  const img = ctx.getImageData(2, 0, ctx.canvas.width - 2, ctx.canvas.height);
  ctx.putImageData(img, 0, 0);
  ctx.clearRect(ctx.canvas.width - 2, 0, 2, ctx.canvas.height);
}

function drawNoise(ctx) {
  ctx.fillStyle = '#002';
  ctx.fillRect(ctx.canvas.width - 2, ctx.canvas.height - 4, 2, 4);
}

function drawSignal(ctx, strength) {
  ctx.fillStyle = '#0af';
  ctx.fillRect(ctx.canvas.width - 2, ctx.canvas.height - strength, 2, strength);
}

setInterval(() => {
  scroll(tx);
  drawNoise(tx);
}, 40);

// ================= UI =================
function enterRadio() {
  pseudo = document.getElementById('pseudoInput').value.trim();
  freq = document.getElementById('freqInput').value.trim().replace(/\./g, '-');
  if (!pseudo || !freq) return;
  document.getElementById('popup').style.display = 'none';
  if (!listening) startListening();
}

// ================= EMISSION =================
function emit(char) {
  const dur = char === '-' ? DASH : DOT;
  playTone(1250, dur);
  drawSignal(tx, char === '-' ? 80 : 40);

  db.ref(`${freq}/chats/emissions/MESSAGE`).push({
    char,
    dur,
    by: pseudo,
    t: Date.now()
  }).then(() => console.log("Message envoyé !"))
    .catch(err => console.error("Erreur Firebase :", err));
}

// ================= AUTO-TRANSLATE =================
const morseCodeMap = {
  '.-':'A','-...':'B','-.-.':'C','-..':'D','.':'E','..-.':'F','--.':'G','....':'H','..':'I',
  '.---':'J','-.-':'K','.-..':'L','--':'M','-.':'N','---':'O','.--.':'P','--.-':'Q','.-.':'R',
  '...':'S','-':'T','..-':'U','...-':'V','.--':'W','-..-':'X','-.--':'Y','--..':'Z',
  '-----':'0','.----':'1','..---':'2','...--':'3','....-':'4','.....':'5','-....':'6',
  '--...':'7','---..':'8','----.':'9'
};

let morseCurrentLetter = "";
let morseWordBuffer = [];
let lastReceivedTime = 0;

function updateTranslation() {
  if(!document.getElementById('translateMode').checked) return;

  let translated = morseWordBuffer.map(letterArr =>
    letterArr.map(c => morseCodeMap[c]||'?').join('')
  ).join(' ');

  receptionDiv.innerText = translated;
}

function processReceivedMorse(char, dur) {
  const now = Date.now();
  const delta = lastReceivedTime ? now - lastReceivedTime : 0;
  lastReceivedTime = now;

  // ajout d'un buffer de 3 units pour fiabilité
  const letterThreshold = 3 * DOT + 3 * DOT; // 6 units
  const wordThreshold = 7 * DOT + 3 * DOT;   // 10 units

  if(delta >= wordThreshold){
    if(morseCurrentLetter) morseWordBuffer.push([morseCurrentLetter]);
    morseWordBuffer.push([]); // nouvel espace pour mot
    morseCurrentLetter = "";
  }
  else if(delta >= letterThreshold){
    if(morseCurrentLetter) morseWordBuffer.push([morseCurrentLetter]);
    morseCurrentLetter = "";
  }

  morseCurrentLetter += char;
  updateTranslation();
}

// ================= RECEPTION =================
function startListening() {
  listening = true;
  let lastTime = 0;

  db.ref(`${freq}/chats/emissions/MESSAGE`).on('child_added', snap => {
    const d = snap.val();
    if (!d || d.by === pseudo) return;
    if (d.t <= lastTime) return;
    lastTime = d.t;

    playTone(800, d.dur);
    receptionDiv.innerText = `Émission de ${d.by}: ${d.char}`;

    if(document.getElementById('translateMode').checked){
        processReceivedMorse(d.char, d.dur);
    }
  });
}
</script>
</body>
</html>
