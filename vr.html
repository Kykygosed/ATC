<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mini VR Map avec mouvement réel</title>
<style>
  body, html {
    margin: 0; padding: 0; overflow: hidden; background: black; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center;
    color: white; font-family: Arial, sans-serif;
  }
  #game {
    position: relative;
    width: 400px;
    height: 400px;
    background: black;
    border: 1px solid white;
  }
  #player {
    position: absolute;
    width: 30px; height: 30px;
    background: blue;
    top: 185px;
    left: 185px;
    transition: top 0.2s, left 0.2s;
  }
  #buttons {
    margin-bottom: 20px;
  }
  button {
    margin: 5px;
    padding: 10px 20px;
    font-size: 16px;
  }
  #info {
    margin-top: 10px;
    font-size: 14px;
  }
</style>
</head>
<body>

<div id="buttons">
  <button id="motionBtn">Autoriser mouvement appareil</button>
  <button id="geoBtn" disabled>Autoriser localisation</button>
</div>

<div id="game">
  <div id="player"></div>
</div>

<div id="info">Position GPS : inconnue<br>Orientation : inconnue</div>

<script>
  const player = document.getElementById('player');
  const motionBtn = document.getElementById('motionBtn');
  const geoBtn = document.getElementById('geoBtn');
  const info = document.getElementById('info');

  let orientation = { alpha: 0, beta: 0, gamma: 0 };
  let position = { lat: null, lon: null };
  let mapPos = { x: 185, y: 185 }; // position du player sur la map 400x400

  // Demande de permission pour le mouvement appareil
  motionBtn.onclick = () => {
    if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
      DeviceOrientationEvent.requestPermission()
        .then(response => {
          if (response === 'granted') {
            window.addEventListener('deviceorientation', handleOrientation);
            info.innerHTML = "Permission mouvement accordée.<br>Attendez la permission localisation.";
            geoBtn.disabled = false;
            motionBtn.disabled = true;
          } else {
            alert('Permission mouvement refusée');
          }
        })
        .catch(console.error);
    } else {
      alert('API mouvement non supportée');
    }
  };

  function handleOrientation(event) {
    // alpha = rotation autour de l’axe z (0 à 360°)
    orientation.alpha = event.alpha || 0;
    orientation.beta = event.beta || 0;
    orientation.gamma = event.gamma || 0;

    // Mise à jour rotation du player (simple exemple: rotation sur z)
    player.style.transform = `rotate(${orientation.alpha}deg)`;

    updateInfo();
  }

  // Demande permission pour la géoloc
  geoBtn.onclick = () => {
    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(handleGeo, err => alert('Erreur géoloc: ' + err.message), { enableHighAccuracy: true });
      geoBtn.disabled = true;
      info.innerHTML += "<br>Permission localisation accordée.";
    } else {
      alert('Géolocalisation non supportée');
    }
  };

  function handleGeo(positionGps) {
    position.lat = positionGps.coords.latitude;
    position.lon = positionGps.coords.longitude;

    // Exemple très simple : déplace le joueur selon latitude/longitude relative
    // Ici, on prend un point de départ arbitraire pour centrer la map :
    const centerLat = 48.8566; // Exemple : Paris
    const centerLon = 2.3522;

    // Calcul différence (en degrés)
    const dLat = position.lat - centerLat;
    const dLon = position.lon - centerLon;

    // Conversion simple en pixels (non réaliste mais pour l'exemple)
    // 0.0001 degrés ~ 10 pixels
    mapPos.x = 185 + dLon * 100000;
    mapPos.y = 185 - dLat * 100000;

    // Limiter pour rester dans la map 400x400
    mapPos.x = Math.min(370, Math.max(0, mapPos.x));
    mapPos.y = Math.min(370, Math.max(0, mapPos.y));

    player.style.left = mapPos.x + 'px';
    player.style.top = mapPos.y + 'px';

    updateInfo();
  }

  function updateInfo() {
    info.innerHTML = `Position GPS : lat ${position.lat ? position.lat.toFixed(5) : "inconnue"}, lon ${position.lon ? position.lon.toFixed(5) : "inconnue"}<br>
                      Orientation : alpha ${orientation.alpha.toFixed(1)}, beta ${orientation.beta.toFixed(1)}, gamma ${orientation.gamma.toFixed(1)}`;
  }

</script>

</body>
</html>
